# AI Chatbot for Financial Markets, Fintech, and AI Concepts

To run this repository locally:
1. Clone this repository
2. Login to supabase.com and create a new project and a documents table using the following sql code:
    1. Create Document table
        ```bash
        -- Enable pgvector extension if not already
        CREATE EXTENSION IF NOT EXISTS vector;

        -- documents table
        CREATE TABLE IF NOT EXISTS documents (
        id text PRIMARY KEY,
        title text NOT NULL,
        file_type text,
        version integer NOT NULL DEFAULT 1,
        updated_at timestamptz NOT NULL DEFAULT now()
        );
        ```
    2. Create Chunks table
        ```bash
        -- Enable pgvector extension if not already
        CREATE EXTENSION IF NOT EXISTS vector;
        -- chunks table
        CREATE TABLE IF NOT EXISTS chunks (
        id text PRIMARY KEY,
        document_id text NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
        chunk_index int NOT NULL,
        text text NOT NULL,
        embedding vector(384) NOT NULL,
        metadata jsonb,        -- e.g. {"page": 5, "section": "Introduction"}
        updated_at timestamptz NOT NULL DEFAULT now()
        );
        -- Index on foreign key for fast joins / deletes
        CREATE INDEX IF NOT EXISTS idx_chunks_document_id ON chunks(document_id);

        -- Full-text search: if you want hybrid search, create a tsvector column:
        ALTER TABLE chunks
        ADD COLUMN IF NOT EXISTS text_tsv tsvector GENERATED ALWAYS AS (to_tsvector('english', text)) STORED;

        -- GIN index on tsvector for keyword filtering / hybrid:
        CREATE INDEX IF NOT EXISTS idx_chunks_text_tsv ON chunks USING GIN(text_tsv);

        -- Vector index for similarity search; IVF Flat example with cosine:
        -- The 'lists' parameter can be tuned; 100 is an example.
        CREATE INDEX IF NOT EXISTS idx_chunks_embedding ON chunks USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
        ```
    3. Create match_chunks function
        ```bash
        CREATE EXTENSION IF NOT EXISTS vector;

        -- Pure vector search: cast similarity to double precision
        CREATE OR REPLACE FUNCTION match_chunks_vector(
        query_embedding vector(384),
        match_count int default 5
        ) RETURNS TABLE (
        id text,
        document_id text,
        chunk_index int,
        text text,
        metadata jsonb,
        similarity float
        )
        AS $$
        SELECT
            c.id,
            c.document_id,
            c.chunk_index,
            c.text,
            c.metadata,
            (c.embedding <-> query_embedding) AS similarity
        FROM chunks c
        ORDER BY c.embedding <-> query_embedding
        LIMIT match_count;
        $$ language sql stable;


        -- Hybrid search: cast both similarity and text_rank to double precision
        create or replace function match_chunks_hybrid(
            query_text text,
            query_embedding vector,
            match_count int default 5
        ) returns table (
            id text,
            document_id text,
            chunk_index int,
            text text,
            metadata jsonb,
            similarity float,
            rank float
        ) as $$
        select
            c.id,
            c.document_id,
            c.chunk_index,
            c.text,
            c.metadata,
            (c.embedding <-> query_embedding) as similarity,
            ts_rank(c.text_tsv, plainto_tsquery('english', query_text)) as rank
        from chunks c
        where c.text_tsv @@ plainto_tsquery('english', query_text)
        order by ( (c.embedding <-> query_embedding) * 0.5 + ts_rank(c.text_tsv, plainto_tsquery('english', query_text)) * 0.5 ) desc
        limit match_count;
        $$ language sql;

        -- Cosine distance search: requires pgvector version supporting <=> operator
        create or replace function match_chunks(
            query_embedding vector, 
            match_count int default 5
        ) returns table (
            id text,
            chunk_index int,
            text text,
            metadata jsonb,
            similarity float
        ) as $$
        select
            id,
            chunk_index,
            text,
            metadata,
            (embedding <-> query_embedding) as similarity
        from chunks
        order by embedding <-> query_embedding 
        limit match_count;
        $$ language sql stable;
        ```
    4. Create Chat_history table
        ```bash
        CREATE TABLE chat_history (
        id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        session_id text NOT NULL,
        role text NOT NULL,
        content text NOT NULL,
        timestamp timestamptz DEFAULT now()
        );
        ```
3. Get the supabase url and key from the dashboard and create your .env file as follows:
    SUPABASE_URL = "your_supabase_url"
    SUPABASE_KEY = "your_supabase_key"

## To RUN
1. Backend
    ```bash
    uvicorn app:app --reload --port 8000
    ```
2. Frontend
    ```bash
    npm run dev
    ```
